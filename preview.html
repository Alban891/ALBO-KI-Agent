<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ALBO Preview</title>
    
    <!-- Office JS f√ºr Dialog -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .preview-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-header {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-title h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .agent-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .preview-body {
            padding: 24px;
        }

        /* Sections */
        .section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #0078d4;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 20px;
        }

        .section-content {
            font-size: 14px;
            line-height: 1.6;
            color: #323130;
        }

        /* E-Mail Details */
        .email-details {
            display: grid;
            gap: 12px;
        }

        .detail-row {
            display: flex;
            gap: 12px;
        }

        .detail-label {
            font-weight: 600;
            width: 100px;
            color: #605e5c;
        }

        .detail-value {
            flex: 1;
        }

        .priority-high {
            color: #d13438;
            font-weight: 600;
        }

        .amount-highlight {
            background: #fff4ce;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* AI Analysis */
        .analysis-box {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .confidence-label {
            font-size: 13px;
            color: #605e5c;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #e1e1e1;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease;
            width: 85%;
        }

        .confidence-value {
            font-weight: 600;
            color: #10b981;
        }

        /* Suggested Reply */
        .reply-preview {
            background: white;
            border: 2px dashed #0078d4;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            font-style: italic;
            color: #323130;
        }

        /* Actions */
        .preview-actions {
            padding: 24px;
            background: #f8f9fa;
            border-top: 1px solid #e1e1e1;
            display: flex;
            gap: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-auto {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-draft {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
        }

        .btn-cancel {
            background: #e1e1e1;
            color: #323130;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e1e1e1;
            border-top-color: #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="preview-container">
        <!-- Header -->
        <div class="preview-header">
            <div class="preview-title">
                <span style="font-size: 28px;">üîç</span>
                <h1>ALBO Preview</h1>
            </div>
            <div id="agentBadge" class="agent-badge">Loading...</div>
            <button class="close-btn" onclick="closeDialog()">‚úï</button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="loading-spinner"></div>
            <p>Analysiere E-Mail mit KI...</p>
        </div>

        <!-- Preview Body -->
        <div id="previewContent" class="preview-body" style="display: none;">
            <!-- E-Mail Details -->
            <div class="section">
                <div class="section-title">
                    <span class="section-icon">üìß</span>
                    <span>E-Mail Details</span>
                </div>
                <div class="email-details">
                    <div class="detail-row">
                        <span class="detail-label">Betreff:</span>
                        <span class="detail-value" id="previewSubject">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Von:</span>
                        <span class="detail-value" id="previewFrom">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Priorit√§t:</span>
                        <span class="detail-value" id="previewPriority">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Kategorie:</span>
                        <span class="detail-value" id="previewCategory">-</span>
                    </div>
                </div>
            </div>

            <!-- KI Analysis -->
            <div class="section">
                <div class="section-title">
                    <span class="section-icon">ü§ñ</span>
                    <span>KI-Analyse</span>
                </div>
                <div class="section-content">
                    <div class="analysis-box">
                        <div id="analysisContent">
                            <p><strong>Zusammenfassung:</strong></p>
                            <p id="analysisSummary">Die E-Mail enth√§lt eine Zahlungserinnerung...</p>
                            
                            <p style="margin-top: 12px;"><strong>Erkannte Details:</strong></p>
                            <ul id="analysisDetails" style="margin-left: 20px;">
                                <li>Betrag: <span class="amount-highlight">15.750,00 EUR</span></li>
                                <li>F√§lligkeit: √úberf√§llig (4 Tage)</li>
                                <li>Rechnungsnummer: 2024-001</li>
                            </ul>
                            
                            <p style="margin-top: 12px;"><strong>Empfohlene Aktionen:</strong></p>
                            <p id="analysisActions">Sofortige Zahlung veranlassen oder Zahlungsplan vereinbaren.</p>
                        </div>
                        
                        <div class="confidence-meter">
                            <span class="confidence-label">KI-Konfidenz:</span>
                            <div class="confidence-bar">
                                <div id="confidenceBar" class="confidence-fill"></div>
                            </div>
                            <span id="confidenceValue" class="confidence-value">85%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggested Reply -->
            <div class="section">
                <div class="section-title">
                    <span class="section-icon">‚úâÔ∏è</span>
                    <span>Vorgeschlagene Antwort</span>
                </div>
                <div class="section-content">
                    <div class="reply-preview" id="suggestedReply">
                        Sehr geehrte Damen und Herren,<br><br>
                        vielen Dank f√ºr Ihre Zahlungserinnerung vom [Datum].<br><br>
                        Wir haben die Rechnung Nr. 2024-001 √ºber 15.750,00 EUR zur Kenntnis genommen.
                        Die Zahlung wird umgehend durch unsere Finanzabteilung veranlasst.<br><br>
                        Wir entschuldigen uns f√ºr die Verz√∂gerung.<br><br>
                        Mit freundlichen Gr√º√üen<br>
                        [Agent Name]<br>
                        ALBO Finance Team
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div id="previewActions" class="preview-actions" style="display: none;">
            <button class="action-btn btn-auto" onclick="executeAction('auto')">
                <span>üöÄ</span>
                <span>Automatisch senden</span>
            </button>
            <button class="action-btn btn-draft" onclick="executeAction('draft')">
                <span>‚úèÔ∏è</span>
                <span>Als Entwurf</span>
            </button>
            <button class="action-btn btn-cancel" onclick="closeDialog()">
                <span>‚ùå</span>
                <span>Abbrechen</span>
            </button>
        </div>
    </div>

    <script>
        let emailData = null;
        let agentType = null;

        // Initialize on load
        window.onload = function() {
            loadPreviewData();
        };

        // Load data from URL parameters
        function loadPreviewData() {
            try {
                const params = new URLSearchParams(window.location.search);
                const data = JSON.parse(decodeURIComponent(params.get('data') || '{}'));
                
                emailData = data.email;
                agentType = data.agent;
                
                // Update UI
                updateAgentBadge();
                populateEmailDetails();
                
                // Simulate AI analysis
                setTimeout(() => {
                    performAIAnalysis();
                }, 1500);
                
            } catch (error) {
                console.error('Error loading preview data:', error);
                showError();
            }
        }

        // Update agent badge
        function updateAgentBadge() {
            const agentNames = {
                'kreditor': 'üí≥ Kreditorenbuchhalter',
                'debitor': 'üí∞ Debitorenbuchhalter',
                'controller': 'üìä Controller',
                'cfo': 'üëî CFO',
                'treasury': 'üè¶ Treasury',
                'ma': 'ü§ù M&A Berater'
            };
            
            document.getElementById('agentBadge').textContent = agentNames[agentType] || 'Finance Agent';
        }

        // Populate email details
        function populateEmailDetails() {
            if (!emailData) return;
            
            document.getElementById('previewSubject').textContent = emailData.subject || '-';
            document.getElementById('previewFrom').textContent = emailData.from || '-';
            
            // Determine priority
            const text = (emailData.subject + ' ' + (emailData.body || '')).toLowerCase();
            if (text.includes('mahnung') || text.includes('dringend') || text.includes('√ºberf√§llig')) {
                document.getElementById('previewPriority').innerHTML = '<span class="priority-high">Hoch</span>';
            } else {
                document.getElementById('previewPriority').textContent = 'Normal';
            }
            
            // Determine category
            if (text.includes('rechnung') || text.includes('invoice')) {
                document.getElementById('previewCategory').textContent = 'Rechnung';
            } else if (text.includes('mahnung')) {
                document.getElementById('previewCategory').textContent = 'Mahnung';
            } else {
                document.getElementById('previewCategory').textContent = 'Gesch√§ftskorrespondenz';
            }
        }

        // Perform AI Analysis (simulated)
        function performAIAnalysis() {
            // Generate analysis based on email content
            const text = (emailData.subject + ' ' + (emailData.body || '')).toLowerCase();
            
            // Extract amounts
            const amountMatch = text.match(/(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)\s*eur/i);
            const amount = amountMatch ? amountMatch[1] : '0,00';
            
            // Update analysis content
            if (text.includes('mahnung')) {
                document.getElementById('analysisSummary').textContent = 
                    'Die E-Mail enth√§lt eine Zahlungserinnerung f√ºr eine √ºberf√§llige Rechnung. Sofortiges Handeln ist erforderlich.';
                
                document.getElementById('analysisDetails').innerHTML = `
                    <li>Betrag: <span class="amount-highlight">${amount} EUR</span></li>
                    <li>Status: <span class="priority-high">√úberf√§llig</span></li>
                    <li>Empf√§nger: ${emailData.from}</li>
                `;
                
                document.getElementById('analysisActions').textContent = 
                    'Sofortige Zahlung veranlassen oder Kontakt zur Kl√§rung aufnehmen.';
                
                // High confidence for clear cases
                updateConfidence(92);
                
            } else if (text.includes('rechnung')) {
                document.getElementById('analysisSummary').textContent = 
                    'Neue Rechnung zur Bearbeitung eingegangen.';
                
                document.getElementById('analysisDetails').innerHTML = `
                    <li>Betrag: <span class="amount-highlight">${amount} EUR</span></li>
                    <li>Status: Neu</li>
                    <li>Absender: ${emailData.from}</li>
                `;
                
                document.getElementById('analysisActions').textContent = 
                    'Rechnung pr√ºfen und zur Zahlung freigeben.';
                
                updateConfidence(85);
            } else {
                // Default analysis
                document.getElementById('analysisSummary').textContent = 
                    'Gesch√§ftliche E-Mail zur weiteren Bearbeitung.';
                
                updateConfidence(70);
            }
            
            // Generate suggested reply
            generateSuggestedReply(text, amount);
            
            // Show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('previewContent').style.display = 'block';
            document.getElementById('previewActions').style.display = 'flex';
        }

        // Generate suggested reply
        function generateSuggestedReply(text, amount) {
            let reply = '';
            
            if (text.includes('mahnung')) {
                reply = `Sehr geehrte Damen und Herren,<br><br>
                    vielen Dank f√ºr Ihre Zahlungserinnerung.<br><br>
                    Wir haben den offenen Betrag von ${amount} EUR zur Kenntnis genommen 
                    und werden die Zahlung umgehend veranlassen.<br><br>
                    Wir entschuldigen uns f√ºr die entstandenen Unannehmlichkeiten.<br><br>
                    Mit freundlichen Gr√º√üen<br>
                    ${getAgentTitle()}<br>
                    ALBO Finance Team`;
            } else if (text.includes('rechnung')) {
                reply = `Sehr geehrte Damen und Herren,<br><br>
                    wir best√§tigen den Erhalt Ihrer Rechnung √ºber ${amount} EUR.<br><br>
                    Die Rechnung wird gepr√ºft und nach Freigabe zur Zahlung angewiesen.<br><br>
                    Mit freundlichen Gr√º√üen<br>
                    ${getAgentTitle()}<br>
                    ALBO Finance Team`;
            } else {
                reply = `Sehr geehrte Damen und Herren,<br><br>
                    vielen Dank f√ºr Ihre Nachricht.<br><br>
                    Ihr Anliegen wurde an unseren ${getAgentTitle()} weitergeleitet 
                    und wird zeitnah bearbeitet.<br><br>
                    Mit freundlichen Gr√º√üen<br>
                    ALBO Finance Team`;
            }
            
            document.getElementById('suggestedReply').innerHTML = reply;
        }

        // Get agent title
        function getAgentTitle() {
            const titles = {
                'kreditor': 'Kreditorenbuchhalter',
                'debitor': 'Debitorenbuchhalter',
                'controller': 'Controller',
                'cfo': 'CFO',
                'treasury': 'Treasury Manager',
                'ma': 'M&A Berater'
            };
            return titles[agentType] || 'Finance Specialist';
        }

        // Update confidence
        function updateConfidence(value) {
            document.getElementById('confidenceBar').style.width = value + '%';
            document.getElementById('confidenceValue').textContent = value + '%';
        }

        // Execute action
        function executeAction(action) {
            // Send message back to parent
            if (Office && Office.context && Office.context.ui) {
                Office.context.ui.messageParent(JSON.stringify({
                    action: action,
                    data: {
                        email: emailData,
                        agent: agentType,
                        reply: document.getElementById('suggestedReply').innerHTML
                    }
                }));
            }
        }

        // Close dialog
        function closeDialog() {
            if (Office && Office.context && Office.context.ui) {
                Office.context.ui.messageParent(JSON.stringify({ action: 'close' }));
            } else {
                window.close();
            }
        }

        // Show error
        function showError() {
            document.getElementById('loadingState').innerHTML = `
                <p style="color: #d13438;">‚ùå Fehler beim Laden der Vorschau</p>
            `;
        }
    </script>
</body>
</html>